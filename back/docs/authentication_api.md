# 認証 API 仕様書

## 概要

このドキュメントでは、Travel Planner アプリケーションの認証に関する API 仕様を説明します。

## 認証方式

- JWT（JSON Web Token）を使用
- トークンは`Authorization`ヘッダーに`Bearer <token>`の形式で付与
- トークンの有効期限は 24 時間

## API エンドポイント

### 1. ユーザー登録

新規ユーザーを作成し、認証トークンを発行します。

- **エンドポイント**: `POST /api/v1/signup`
- **認証**: 不要

#### リクエストボディ

```json
{
  "email": "user@example.com",
  "password": "password123",
  "password_confirmation": "password123",
  "name": "山田太郎"
}
```

#### 成功時レスポンス

- **ステータスコード**: 200 OK

```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "name": "山田太郎"
  }
}
```

#### エラーレスポンス

- **ステータスコード**: 422 Unprocessable Entity

```json
{
  "errors": [
    "Emailはすでに存在します",
    "Passwordは6文字以上である必要があります"
  ]
}
```

### 2. ログイン

既存ユーザーの認証を行い、トークンを発行します。

- **エンドポイント**: `POST /api/v1/login`
- **認証**: 不要

#### リクエストボディ

```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

#### 成功時レスポンス

- **ステータスコード**: 200 OK

```json
{
  "token": "eyJhbGciOiJIUzI1NiJ9...",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "name": "山田太郎"
  }
}
```

#### エラーレスポンス

- **ステータスコード**: 401 Unauthorized

```json
{
  "errors": "メールアドレスまたはパスワードが正しくありません"
}
```

### 3. プロフィール取得

現在ログインしているユーザーの情報を取得します。

- **エンドポイント**: `GET /api/v1/profile`
- **認証**: 必要

#### リクエストヘッダー

```
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

#### 成功時レスポンス

- **ステータスコード**: 200 OK

```json
{
  "user": {
    "id": 1,
    "email": "user@example.com",
    "name": "山田太郎",
    "image_url": "https://example.com/avatar.jpg"
  }
}
```

#### エラーレスポンス

- **ステータスコード**: 401 Unauthorized

```json
{
  "errors": "認証が必要です"
}
```

### 4. ログアウト

ユーザーをログアウトします。

- **エンドポイント**: `POST /api/v1/logout`
- **認証**: 必要

#### リクエストヘッダー

```
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

#### 成功時レスポンス

- **ステータスコード**: 200 OK

```json
{
  "message": "ログアウトしました"
}
```

#### エラーレスポンス

- **ステータスコード**: 401 Unauthorized

```json
{
  "error": "無効なトークンです"
}
```

または

```json
{
  "error": "トークンの検証に失敗しました"
}
```

## エラーレスポンス共通フォーマット

認証に失敗した場合、以下のような形式でエラーが返されます：

```json
{
  "errors": "エラーメッセージ"
}
```

または

```json
{
  "error": "エラーメッセージ"
}
```

## セッション管理

### フロントエンド（Next.js）

1. **セッションの保存**

   - NextAuth を使用してセッション情報を管理
   - JWT ストラテジーを採用し、クライアントサイドでセッションを保持
   - セッション情報にはユーザー情報とバックエンドの JWT トークンを含む

2. **セッションの利用**

   - 保護されたページへのアクセス時に自動的にセッションチェック
   - API リクエスト時にバックエンドトークンを自動的に付与
   - セッション切れの場合は自動的にログインページにリダイレクト

3. **セッションの更新**
   - セッションは 24 時間有効
   - ログアウト時にフロントエンド・バックエンド両方のセッションをクリア

### バックエンド（Rails）

1. **認証トークンの検証**

   - すべての API リクエストで Authorization ヘッダーを検証
   - トークンが無効な場合は 401 Unauthorized を返却
   - トークンの有効期限切れの場合も 401 Unauthorized を返却

2. **保護されたリソースへのアクセス**

   - `authenticate_user!`フィルターを使用して認証を強制
   - 認証済みユーザーのみがアクセス可能なエンドポイントを保護
   - 未認証アクセスは自動的に拒否

3. **トークンの管理**
   - JWT トークンにユーザー ID と有効期限を含む
   - トークンの再利用を防ぐための仕組みは現状含まれていない
   - 必要に応じてトークンのブラックリスト機能を追加可能

### セキュリティ上の注意点

1. **トークンの取り扱い**

   - トークンは HTTPS でのみ送信
   - フロントエンドではセキュアなストレージにのみ保存
   - ログアウト時は確実にトークンを破棄

2. **クロスサイトリクエストフォージェリ（CSRF）対策**

   - JWT を使用することで CSRF 対策は不要
   - ただし、Cookie ベースの認証に変更する場合は CSRF 対策が必要

3. **クロスオリジンリソース共有（CORS）**
   - フロントエンド（localhost:3000）からのリクエストのみを許可
   - 本番環境では適切なオリジンの設定が必要

## 注意事項

- すべての API リクエストは、ログインエンドポイントとサインアップエンドポイントを除き、有効な JWT トークンが必要です
- トークンの有効期限は 24 時間です
- パスワードは安全なハッシュ化を行って保存されます
- OAuth（Google 認証）を使用する場合は別途ドキュメントを参照してください
